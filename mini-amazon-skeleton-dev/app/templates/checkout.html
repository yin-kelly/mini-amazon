{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Checkout</h2>

  {% if items and items|length > 0 %}
  <table class="table table-hover table-bordered">
    <thead class="thead-dark">
      <tr>
        <th>Product</th>
        <th>Seller</th>
        <th class="text-center">Requested</th>
        <th class="text-center">Available</th>
        <th class="text-right">Unit Price</th>
        <th class="text-right">Line Total</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for it in items %}
      <tr class="{% if not it.ok %}table-warning{% endif %}">
        <td>#{{ it.product_id }} — {{ it.product_name }}</td>
        <td>#{{ it.seller_id }}</td>
        <td class="text-center">{{ it.requested_qty }}</td>
        <td class="text-center">{{ it.available_qty }}</td>
        <td class="text-right">
          ${{ '%.2f'|format(it.current_price|default(0.0)) }}
        </td>
        <td class="text-right">
          {% if it.ok %}
            ${{ '%.2f'|format(it.line_total) }}
          {% else %}
            —
          {% endif %}
        </td>
        <td>
          {% if it.ok %}
            OK
          {% else %}
            {{ it.error or 'Quantity exceeds stock' }}
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <th colspan="5" class="text-right">Subtotal (valid items)</th>
        <th class="text-right">${{ '%.2f'|format(subtotal) }}</th>
        <th></th>
      </tr>
    </tfoot>
  </table>

  {% if items|selectattr('ok')|list|length == items|length %}
    <!-- All good: allow placing the order -->
    <form method="post" action="{{ url_for('checkout.checkout_place') }}">
      <button class="btn btn-primary">Place Order</button>
      <a class="btn btn-outline-dark" href="{{ url_for('cart.cart_page') }}">Back to Cart</a>
    </form>
  {% else %}
    <!-- Some invalid: force user back to cart to fix -->
    <div class="alert alert-warning">
      Some items exceed available stock. Please adjust quantities in your cart.
    </div>
    <a class="btn btn-outline-dark" href="{{ url_for('cart.cart_page') }}">Fix in Cart</a>
  {% endif %}
  {% else %}
    <p>Your cart is empty.</p>
    <a class="btn btn-outline-dark" href="{{ url_for('index.index') }}">Continue shopping</a>
  {% endif %}
</div>
{% endblock %}