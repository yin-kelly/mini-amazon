{% extends "base.html" %}
{% block title %}Message Thread - Order #{{ thread.order_id }}{% endblock %}
{% block content %}

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>Order #{{ thread.order_id }}</h2>
      <small class="text-muted">
        <strong>Buyer:</strong> {{ thread.buyer_name }} | 
        <strong>Seller:</strong> {{ thread.seller_name }} | 
        <strong>Status:</strong> {{ thread.order_status }}
      </small>
    </div>
    <a href="{{ url_for('messaging.index') }}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left"></i> Back to Messages
    </a>
  </div>

  <div class="row">
    <div class="col-md-8">
      <!-- Messages -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Messages</h5>
        </div>
        <div class="card-body" style="height: 400px; overflow-y: auto;">
          {% if messages %}
            {% for message in messages %}
            <div class="message mb-3 {% if message.sender_id == current_user.id %}text-right{% endif %}">
              <div class="d-inline-block p-3 rounded {% if message.sender_id == current_user.id %}bg-primary text-white{% else %}bg-light{% endif %}" style="max-width: 70%;">
                <div class="message-content">{{ message.content }}</div>
                <small class="{% if message.sender_id == current_user.id %}text-white-50{% else %}text-muted{% endif %}">
                  {{ message.sender_name }} - {{ message.created_at.strftime('%Y-%m-%d %H:%M') }}
                </small>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="text-center text-muted py-4">
              <p>No messages yet. Start the conversation!</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Send Message Form -->
      <div class="card mt-3">
        <div class="card-body">
          <form method="POST" action="{{ url_for('messaging.send_message', thread_id=thread.id) }}">
            <div class="form-group">
              <textarea name="content" class="form-control" rows="3" 
                        placeholder="Type your message..." required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-paper-plane"></i> Send Message
            </button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <!-- Order Info -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Order Information</h6>
        </div>
        <div class="card-body">
          <p><strong>Order ID:</strong> {{ thread.order_id }}</p>
          <p><strong>Order Date:</strong> {{ thread.order_date.strftime('%Y-%m-%d') }}</p>
          <p><strong>Status:</strong> {{ thread.order_status }}</p>
          <p><strong>Buyer:</strong> {{ thread.buyer_name }}</p>
          <p><strong>Seller:</strong> {{ thread.seller_name }}</p>
          
          <hr>
          <a href="{{ url_for('orders.order_detail', order_id=thread.order_id) }}" 
             class="btn btn-outline-primary btn-sm">
            View Order Details
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.message {
  word-wrap: break-word;
}
.message-content {
  white-space: pre-wrap;
}
</style>

{% endblock %}
