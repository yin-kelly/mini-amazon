{% extends "base.html" %}
{% block title %}My Profile{% endblock %}
{% block content %}

<div class="container my-4">
  <h3 class="mb-4">Hello, {{ user.firstname }} {{ user.lastname }}</h3>

  <!-- Top row: Profile Info | Reviews (placeholder) | Balance -->
  <div class="row">
    <!-- Profile Info -->
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Profile Info</h5>
          <p class="mb-1"><strong>Name:</strong> {{ user.firstname }} {{ user.lastname }}</p>
          <p class="mb-1"><strong>Email:</strong> {{ user.email }}</p>
          <p class="mb-1"><strong>Address:</strong> {{ user.address or "â€”" }}</p>
          <div class="mt-2 text-muted small">
            <a href="{{ url_for('users.edit_profile') }}" class="btn btn-sm btn-outline-primary">Edit Profile</a>
            <a href="{{ url_for('users.public_user_view', user_id=user.id) }}" class="btn btn-sm btn-outline-info ml-1">Public View</a>
            <a href="{{ url_for('users.logout') }}" class="btn btn-sm btn-outline-danger ml-1">Logout</a>
            <p class="mb-1 mt-2"><strong>ID:</strong> {{ user.id }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Reviews Athena -->
<div class="col-md-4 mb-3">
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title">My Recent Reviews</h5>
      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('reviews.my_reviews') }}">
        View my reviews
      </a>
    </div>
  </div>
</div>

    <!-- Balance -->
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Balance and Payments</h5>
          <p class="mb-1"><strong>Current Balance:</strong>
            ${{ "{:.2f}".format((user.balance or 0)) }}</p>
          <div class="mt-2">
            <a href="{{ url_for('users.balance_management') }}" class="btn btn-sm btn-outline-success">Manage Balance</a>
          </div>
          <div class="text-muted small mt-2">Add funds or withdraw from your account</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Order History (Users Guru requirement) -->
  <div class="row mt-2">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3">Order History</h5>

          {% if order_summaries %}
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead>
                  <tr>
                    <th scope="col">Order #</th>
                    <th scope="col">Date</th>
                    <th scope="col">Status</th>
                    <th scope="col" class="text-center">Items</th>
                    <th scope="col" class="text-center">Quantity</th>
                    <th scope="col" class="text-end">Total</th>
                    <th scope="col">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for order in order_summaries %}
                  <tr>
                    <td><strong>#{{ order.order_id }}</strong></td>
                    <td>{{ order.time_ordered.strftime('%Y-%m-%d %H:%M') if order.time_ordered else 'N/A' }}</td>
                    <td>
                      <span class="badge 
                        {% if order.status in ['Delivered','Success','Successful','Completed'] %}badge-success
                        {% elif order.status in ['Shipped','Shipping'] %}badge-info
                        {% elif order.status in ['Processing','Partially Fulfilled'] %}badge-warning
                        {% elif order.status in ['Failed','Cancelled'] %}badge-danger
                        {% else %}badge-secondary{% endif %}">
                        {{ order.status }}
                      </span>
                    </td>
                    <td class="text-center">{{ order.item_count }}</td>
                    <td class="text-center">{{ order.total_quantity }}</td>
                    <td class="text-end"><strong>${{ "{:.2f}".format(order.total_price) }}</strong></td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <a href="{{ url_for('orders.order_detail', order_id=order.order_id) }}" 
                           class="btn btn-outline-primary" title="View Order Details">
                          View Details
                        </a>
                        <form method="POST" action="{{ url_for('users.buy_again_order', order_id=order.order_id) }}" style="display: inline;">
                          <button type="submit" class="btn btn-outline-success" title="Buy All Items Again">
                            Buy Again
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            {% if purchases %}
              <!-- Fallback: Show individual purchase items if no orders -->
              <div class="alert alert-info">
                <h6>Individual Purchase Items</h6>
                <p class="mb-0">Showing individual items from your purchase history.</p>
              </div>
              <div class="table-responsive">
                <table class="table table-sm table-hover align-middle">
                  <thead>
                    <tr>
                      <th scope="col">#</th>
                      <th scope="col">Product</th>
                      <th scope="col" class="text-end">Price</th>
                      <th scope="col">Purchased At (UTC)</th>
                      <th scope="col">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for p in purchases %}
                    <tr>
                      <td>{{ p.id }}</td>
                      <td>{{ p.product_name }}</td>
                      <td class="text-end">${{ "{:.2f}".format(p.price) }}</td>
                      <td>{{ p.time_purchased }}</td>
                      <td>
                        <form method="POST" action="{{ url_for('users.buy_again', purchase_id=p.id) }}" style="display: inline;">
                          <button type="submit" class="btn btn-sm btn-outline-primary">
                            Buy Again
                          </button>
                        </form>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-center py-4">
                <p class="text-muted mb-3">No orders or purchases yet.</p>
                <a href="{{ url_for('index.index') }}" class="btn btn-primary">Start Shopping</a>
              </div>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}
